# 员工能力测评系统 - 腾讯云部署总结

## 📋 项目概览

**项目名称**: 员工能力测评系统  
**目标服务器**: 腾讯云 CentOS (TencentOS4-Linux)  
**服务器IP**: 124.223.40.219  
**部署方式**: Git + 自动化脚本部署  
**架构**: Nginx + Gunicorn + Supervisor + SQLite

## ✅ 已完成的部署准备工作

### 1. 数据库迁移准备 ✓
- [x] **数据库迁移脚本**: `database_migration.py` - 完整的数据库导出工具
- [x] **SQL迁移文件**: `database_migration.sql` - 包含完整表结构和数据
- [x] **JSON备份文件**: `database_backup.json` - 便于查看的JSON格式备份
- [x] **数据验证**: 确认包含125条题目记录和完整的表结构

### 2. 生产环境配置文件 ✓
- [x] **生产应用**: `production_app.py` - 优化的生产环境Flask应用
- [x] **Gunicorn配置**: `gunicorn.conf.py` - 生产级Web服务器配置
- [x] **Nginx配置**: `production_nginx.conf` - 反向代理和静态文件服务
- [x] **Supervisor配置**: `production_supervisor.conf` - 进程管理配置
- [x] **环境变量模板**: `.env.example` - 完整的环境变量配置模板

### 3. 自动化部署工具 ✓
- [x] **自动部署脚本**: `deploy_to_tencent_cloud.sh` - 一键部署到腾讯云
- [x] **Git部署指南**: `Git部署指南.md` - 详细的Git部署流程
- [x] **部署指南**: `生产部署指南与注意事项.md` - 完整的部署指南
- [x] **命令速查**: `部署命令速查.md` - 常用运维命令汇总

### 4. 项目结构优化 ✓
- [x] **开发/生产分离**: 分离开发环境(`new_app.py`)和生产环境(`production_app.py`)
- [x] **配置管理**: 独立的环境变量配置和生产环境优化
- [x] **依赖管理**: `requirements-production.txt` - 生产环境专用依赖

## 🚀 部署方案选择

### 方案一：自动化脚本部署（推荐）
```bash
# 1. 本地设置Git仓库地址
export GIT_REPO_URL="https://your-git-repo-url.git"

# 2. 执行一键部署
chmod +x deploy_to_tencent_cloud.sh
./deploy_to_tencent_cloud.sh
```

**优势**: 
- 全自动化，减少人为错误
- 包含完整的环境检查和错误处理
- 自动备份现有部署

### 方案二：手动Git部署
```bash
# 1. 本地代码提交
git init && git add . && git commit -m "Production ready"
git remote add origin https://your-git-repo-url.git
git push -u origin main

# 2. 服务器手动部署
ssh root@124.223.40.219
# 按照《Git部署指南.md》执行部署步骤
```

**优势**: 
- 可控性强，便于调试
- 适合首次部署或复杂环境

## 🔧 关键配置要点

### 1. 必须修改的安全配置
```bash
# 在 .env 文件中必须修改：
SECRET_KEY=生成32位以上随机字符串
DEEPSEEK_API_KEY=sk-您的真实API密钥
ADMIN_PASSWORD=强密码替换默认密码
```

### 2. 数据库配置
- **开发环境**: `./new_questions.db`
- **生产环境**: `/home/www/flask_project/data/new_questions.db`
- **迁移方式**: 使用 `database_migration.sql` 文件导入

### 3. 服务架构
```
Internet → Nginx (80) → Gunicorn (8000) → Flask App → SQLite
                ↓
           Supervisor (进程管理)
```

## 📁 重要文件清单

### 核心应用文件
- `production_app.py` - 生产环境Flask应用
- `database_migration.sql` - 数据库迁移文件
- `database_backup.json` - 数据库JSON备份

### 配置文件
- `.env` (从 `.env.example` 复制并修改)
- `gunicorn.conf.py` - Gunicorn服务器配置
- `production_nginx.conf` - Nginx反向代理配置
- `production_supervisor.conf` - Supervisor进程管理配置

### 部署工具
- `deploy_to_tencent_cloud.sh` - 自动部署脚本
- `requirements-production.txt` - 生产环境依赖

### 文档
- `Git部署指南.md` - Git部署详细步骤
- `生产部署指南与注意事项.md` - 完整部署指南
- `部署命令速查.md` - 运维命令参考

## 🎯 部署步骤总览

### 第一步：本地准备 (5分钟)
1. 运行 `python database_migration.py` 生成数据库迁移文件
2. 复制 `.env.example` 为 `.env` 并修改关键配置
3. 创建Git仓库并推送代码

### 第二步：服务器部署 (15-30分钟)
1. SSH连接到腾讯云服务器 `ssh root@124.223.40.219`
2. 运行自动部署脚本或按手动步骤部署
3. 验证服务状态和功能正常

### 第三步：部署验证 (5分钟)
1. 访问 `http://124.223.40.219` 检查主页面
2. 访问 `http://124.223.40.219/health` 检查健康状态
3. 访问 `http://124.223.40.219/manage` 检查管理后台

## 🔍 部署验证检查清单

### 系统检查 ✓
- [ ] 服务器连接正常
- [ ] Python3、Nginx、Supervisor已安装
- [ ] 防火墙已开放80、443端口
- [ ] 系统时间和时区正确

### 应用检查 ✓
- [ ] Git代码拉取成功
- [ ] Python虚拟环境创建成功
- [ ] 依赖包安装完成
- [ ] 数据库迁移成功
- [ ] 环境变量配置正确

### 服务检查 ✓
- [ ] Nginx配置正确并启动
- [ ] Supervisor配置正确并启动
- [ ] Flask应用进程运行正常
- [ ] 端口监听正常

### 功能检查 ✓
- [ ] 主页面 (/) 可访问
- [ ] 健康检查 (/health) 正常
- [ ] API接口 (/api/*) 正常
- [ ] 管理后台 (/manage) 可访问
- [ ] 用户登录功能正常
- [ ] 测评流程完整
- [ ] 报告生成正常

## 🛡️ 安全配置建议

### 1. 强制性安全配置
```bash
# 修改默认密钥和密码
SECRET_KEY=随机生成的32位以上字符串
ADMIN_PASSWORD=复杂的强密码
DEEPSEEK_API_KEY=有效的API密钥

# 文件权限
chmod 600 .env
chmod 664 data/new_questions.db
chown -R www:www /home/www/flask_project
```

### 2. 可选安全加固
- **SSL证书**: 配置Let's Encrypt免费SSL证书
- **访问控制**: 限制管理后台访问IP
- **防火墙**: 配置iptables或firewalld规则
- **日志监控**: 设置异常访问告警

## 📊 运维管理

### 日常运维命令
```bash
# 服务状态检查
systemctl status nginx supervisord
supervisorctl status employee_assessment

# 重启应用
supervisorctl restart employee_assessment

# 查看日志
tail -f /var/log/supervisor/flask_app_stdout.log
tail -f /home/www/flask_project/logs/app.log

# 系统资源监控
htop
df -h
free -h
```

### 备份策略
```bash
# 自动备份脚本已配置
/home/www/backup_script.sh

# 定时任务
0 2 * * * /home/www/backup_script.sh  # 每日2点备份
*/5 * * * * /home/www/monitor.sh      # 每5分钟监控检查
```

## 🔄 更新部署流程

### 代码更新
```bash
# 1. 本地提交
git add . && git commit -m "Update" && git push

# 2. 服务器更新
ssh root@124.223.40.219
cd /home/www/flask_project
sudo -u www git pull origin main
supervisorctl restart employee_assessment
```

### 数据库更新
```bash
# 如果有数据库结构变更，重新生成迁移文件
python database_migration.py
# 上传并在服务器执行迁移
```

## 🚨 故障处理

### 常见问题快速定位
1. **应用无法启动**: 检查 `supervisorctl tail employee_assessment stderr`
2. **502错误**: 检查 `curl http://127.0.0.1:8000/health` 和Nginx日志
3. **数据库错误**: 检查文件权限和数据库完整性
4. **配置错误**: 验证 `.env` 文件配置和环境变量

### 应急恢复
```bash
# 回滚到上一个版本
git reset --hard HEAD~1
supervisorctl restart employee_assessment

# 从备份恢复数据库
cp /home/www/flask_project/backup/database_latest.db \
   /home/www/flask_project/data/new_questions.db
```

## 🎉 部署完成

### 系统访问信息
- **主页面**: http://124.223.40.219
- **管理后台**: http://124.223.40.219/manage
- **健康检查**: http://124.223.40.219/health
- **API接口**: http://124.223.40.219/api/

### 管理员登录
- **用户名**: admin (或您设置的用户名)
- **密码**: 您在 .env 文件中设置的密码

### 重要提醒
1. **立即修改默认密码**和API密钥
2. **定期检查系统日志**和服务状态
3. **设置SSL证书**提升安全性
4. **定期备份数据**防止意外丢失
5. **监控系统资源**确保服务稳定

---

**🎯 部署成功标志**: 
- 所有服务正常运行 ✅
- 主要功能测试通过 ✅  
- 安全配置已完成 ✅
- 监控和备份已设置 ✅

**📞 技术支持**: 如遇到部署问题，请参考相关文档或检查日志文件进行排查。
