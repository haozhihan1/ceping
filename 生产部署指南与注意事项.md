# 员工能力测评系统 - 生产部署指南与注意事项

## 🎯 部署概述

本指南详细说明了将员工能力测评系统从开发环境部署到腾讯云CentOS生产环境的完整流程、配置要求和关键注意事项。

**服务器信息**
- **IP地址**: 124.223.40.219
- **操作系统**: TencentOS4-Linux (CentOS兼容)
- **架构**: Nginx + Gunicorn + Supervisor + SQLite

## ⚠️ 部署前必读事项

### 1. 数据安全
- ✅ **必须备份本地数据库**: 运行 `python database_migration.py` 生成迁移文件
- ✅ **验证迁移文件完整性**: 检查 `database_migration.sql` 和 `database_backup.json`
- ✅ **测试数据恢复**: 本地测试迁移文件能否正确恢复数据

### 2. 安全配置
- 🔐 **SECRET_KEY**: 必须生成32位以上随机字符串，绝不能使用默认值
- 🔐 **DEEPSEEK_API_KEY**: 必须使用有效的API密钥
- 🔐 **管理员密码**: 必须修改默认密码 `admin123`
- 🔐 **数据库权限**: 确保SQLite文件权限正确设置

### 3. 网络和防火墙
- 🌐 **端口开放**: 确保80和443端口在腾讯云安全组中已开放
- 🌐 **域名解析**: 如使用域名，确保DNS解析正确指向服务器IP
- 🌐 **SSL证书**: 生产环境建议配置HTTPS

## 📋 详细部署步骤

### 第一阶段：本地准备

#### 1.1 生成数据库迁移文件

```bash
# 在项目根目录执行
cd "d:\Project -new"
python database_migration.py

# 验证生成的文件
dir database_migration.sql
dir database_backup.json
```

**验证要点**:
- 确认SQL文件包含所有表结构和数据
- 检查记录数是否正确（应该有125条question记录）
- 确保中文数据没有乱码

#### 1.2 配置生产环境变量

编辑 `production.env` 文件：

```env
# 🔴 必须修改的安全配置
SECRET_KEY=请替换为32位以上随机字符串
DEEPSEEK_API_KEY=sk-请替换为真实的API密钥
ADMIN_USERNAME=admin
ADMIN_PASSWORD=请替换为强密码

# 服务器配置
HOST=0.0.0.0
PORT=8000
WORKERS=4

# 数据库路径
DATABASE_PATH=/home/www/flask_project/data/new_questions.db

# 日志级别
LOG_LEVEL=INFO
```

#### 1.3 准备Git仓库

```bash
# 初始化Git（如果尚未初始化）
git init
git branch -M main

# 添加.gitignore
echo "*.db" >> .gitignore
echo ".env" >> .gitignore
echo "__pycache__/" >> .gitignore
echo "venv/" >> .gitignore
echo "logs/" >> .gitignore

# 提交代码
git add .
git commit -m "Production deployment ready"

# 推送到远程仓库
git remote add origin https://your-git-repo-url.git
git push -u origin main
```

### 第二阶段：服务器部署

#### 2.1 连接服务器

```bash
# 使用SSH连接
ssh root@124.223.40.219

# 或使用密钥连接
ssh -i /path/to/your-key.pem root@124.223.40.219
```

#### 2.2 系统环境准备

```bash
# 更新系统
yum update -y

# 安装基础依赖
yum install -y wget curl git unzip vim htop

# 安装Python3
yum install -y python3 python3-pip python3-devel

# 安装编译工具（某些Python包需要）
yum groupinstall -y "Development Tools"

# 安装Web服务
yum install -y nginx supervisor

# 配置腾讯云pip镜像源
mkdir -p ~/.pip
cat > ~/.pip/pip.conf << 'EOF'
[global]
index-url = https://mirrors.tencent.com/pypi/simple/
trusted-host = mirrors.tencent.com
timeout = 30
retries = 3
EOF
```

#### 2.3 创建项目环境

```bash
# 创建专用用户
useradd -m -s /bin/bash www
usermod -aG wheel www  # 可选：添加sudo权限

# 创建项目目录结构
mkdir -p /home/www/flask_project/{data,logs,uploads,backup,static}
chown -R www:www /home/www/flask_project

# 设置合适的权限
chmod -R 755 /home/www/flask_project
chmod -R 775 /home/www/flask_project/data
chmod -R 775 /home/www/flask_project/logs
```

#### 2.4 克隆项目代码

```bash
# 切换到项目目录
cd /home/www

# 克隆项目（替换为您的实际仓库地址）
sudo -u www git clone https://your-git-repo-url.git flask_project

# 进入项目目录
cd flask_project
```

#### 2.5 配置Python环境

```bash
# 创建虚拟环境
sudo -u www python3 -m venv venv

# 激活虚拟环境并升级pip
sudo -u www bash -c "source venv/bin/activate && pip install --upgrade pip"

# 安装项目依赖
sudo -u www bash -c "source venv/bin/activate && pip install -r requirements.txt"

# 验证安装
sudo -u www bash -c "source venv/bin/activate && pip list"
```

#### 2.6 配置数据库

```bash
# 确保数据目录存在
mkdir -p /home/www/flask_project/data
chown www:www /home/www/flask_project/data

# 导入数据库（如果有迁移文件）
if [ -f "database_migration.sql" ]; then
    echo "正在导入数据库..."
    sudo -u www sqlite3 data/new_questions.db < database_migration.sql
    echo "数据库导入完成"
else
    echo "未找到迁移文件，将初始化新数据库"
    sudo -u www bash -c "source venv/bin/activate && python init_database.py"
    mv new_questions.db data/ 2>/dev/null || true
fi

# 设置数据库权限
chown www:www data/new_questions.db
chmod 664 data/new_questions.db

# 验证数据库
sudo -u www sqlite3 data/new_questions.db "SELECT COUNT(*) FROM questions;"
```

#### 2.7 配置环境变量

```bash
# 复制环境配置
sudo -u www cp production.env .env

# 编辑配置文件
sudo -u www vim .env
```

**重要：必须修改以下配置**
```env
SECRET_KEY=生成一个32位以上的随机字符串
DEEPSEEK_API_KEY=您的真实API密钥
ADMIN_PASSWORD=设置强密码
```

#### 2.8 配置Web服务

```bash
# 备份原始Nginx配置
cp /etc/nginx/nginx.conf /etc/nginx/nginx.conf.backup

# 使用项目的Nginx配置
cp production_nginx.conf /etc/nginx/nginx.conf

# 测试Nginx配置
nginx -t

# 配置Supervisor
cp production_supervisor.conf /etc/supervisord.d/flask_app.ini

# 创建日志目录
mkdir -p /var/log/supervisor
chown -R www:www /var/log/supervisor
```

#### 2.9 启动服务

```bash
# 启动并设置开机自启
systemctl enable nginx supervisord
systemctl start nginx supervisord

# 重新加载Supervisor配置
supervisorctl reread
supervisorctl update

# 启动Flask应用
supervisorctl start employee_assessment

# 检查服务状态
supervisorctl status
systemctl status nginx
```

#### 2.10 配置防火墙

```bash
# 启动防火墙
systemctl start firewalld
systemctl enable firewalld

# 开放HTTP和HTTPS端口
firewall-cmd --permanent --add-port=80/tcp
firewall-cmd --permanent --add-port=443/tcp

# 重载防火墙配置
firewall-cmd --reload

# 验证端口状态
firewall-cmd --list-ports
```

### 第三阶段：部署验证

#### 3.1 服务状态检查

```bash
# 检查所有关键服务
systemctl status nginx
systemctl status supervisord
supervisorctl status employee_assessment

# 检查端口监听
netstat -tlnp | grep :80
netstat -tlnp | grep :8000

# 检查进程
ps aux | grep gunicorn
ps aux | grep nginx
```

#### 3.2 应用功能测试

```bash
# 健康检查
curl -I http://localhost/health
curl -I http://124.223.40.219/health

# 主页面测试
curl http://localhost/
curl http://124.223.40.219/

# API测试
curl -X GET http://124.223.40.219/api/questions

# 管理后台测试
curl -I http://124.223.40.219/manage
```

#### 3.3 日志检查

```bash
# 应用日志
tail -f /var/log/supervisor/flask_app_stdout.log
tail -f /var/log/supervisor/flask_app_stderr.log

# Nginx日志
tail -f /var/log/nginx/access.log
tail -f /var/log/nginx/error.log

# 系统日志
journalctl -u nginx -f
journalctl -u supervisord -f
```

## 🔧 生产环境优化配置

### 1. 性能优化

#### Gunicorn优化
```python
# 在gunicorn.conf.py中调整
workers = cpu_count * 2 + 1  # 根据CPU核数调整
worker_class = "sync"  # 或使用gevent/eventlet
worker_connections = 1000
max_requests = 1000
max_requests_jitter = 50
```

#### Nginx优化
```nginx
# 在nginx.conf中添加
worker_processes auto;
worker_connections 1024;

# 启用gzip压缩
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

# 缓存静态文件
location /static/ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}
```

### 2. 安全加固

#### SSL证书配置
```bash
# 安装certbot
yum install -y certbot python3-certbot-nginx

# 申请Let's Encrypt证书（需要域名）
certbot --nginx -d your-domain.com

# 配置自动续期
echo "0 12 * * * /usr/bin/certbot renew --quiet" | crontab -
```

#### 访问控制
```nginx
# 限制管理后台访问
location /manage {
    allow 您的办公网IP;
    deny all;
    # ... 其他配置
}

# 限制API调用频率
limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
location /api/ {
    limit_req zone=api burst=20 nodelay;
    # ... 其他配置
}
```

### 3. 监控和告警

#### 系统监控脚本
```bash
cat > /home/www/monitor.sh << 'EOF'
#!/bin/bash
LOG_FILE="/home/www/flask_project/logs/monitor.log"
DATE=$(date '+%Y-%m-%d %H:%M:%S')

# 检查服务状态
check_service() {
    service_name=$1
    if systemctl is-active --quiet $service_name; then
        echo "[$DATE] $service_name: OK" >> $LOG_FILE
    else
        echo "[$DATE] $service_name: FAILED" >> $LOG_FILE
        # 这里可以添加告警逻辑
    fi
}

check_service nginx
check_service supervisord

# 检查应用进程
if supervisorctl status employee_assessment | grep -q RUNNING; then
    echo "[$DATE] Flask App: OK" >> $LOG_FILE
else
    echo "[$DATE] Flask App: FAILED" >> $LOG_FILE
    # 尝试重启应用
    supervisorctl restart employee_assessment
fi

# 检查磁盘空间
DISK_USAGE=$(df / | awk 'NR==2 {print $5}' | sed 's/%//')
if [ $DISK_USAGE -gt 80 ]; then
    echo "[$DATE] Disk Usage: WARNING ${DISK_USAGE}%" >> $LOG_FILE
fi

# 检查内存使用
MEM_USAGE=$(free | awk 'NR==2{printf "%.0f", $3*100/$2}')
if [ $MEM_USAGE -gt 80 ]; then
    echo "[$DATE] Memory Usage: WARNING ${MEM_USAGE}%" >> $LOG_FILE
fi
EOF

chmod +x /home/www/monitor.sh

# 添加定时监控
echo "*/5 * * * * /home/www/monitor.sh" | crontab -
```

## 📊 运维管理

### 1. 日常维护命令

```bash
# 重启应用
supervisorctl restart employee_assessment

# 重新加载Nginx配置
nginx -s reload

# 查看实时日志
tail -f /home/www/flask_project/logs/app.log

# 检查系统资源
htop
df -h
free -h

# 查看网络连接
netstat -an | grep :80
```

### 2. 数据库维护

```bash
# 备份数据库
DATE=$(date +%Y%m%d_%H%M%S)
cp /home/www/flask_project/data/new_questions.db \
   /home/www/flask_project/backup/database_$DATE.db

# 优化数据库
sqlite3 /home/www/flask_project/data/new_questions.db "VACUUM;"

# 检查数据库完整性
sqlite3 /home/www/flask_project/data/new_questions.db "PRAGMA integrity_check;"
```

### 3. 自动备份脚本

```bash
cat > /home/www/backup_script.sh << 'EOF'
#!/bin/bash
BACKUP_DIR="/home/www/flask_project/backup"
DATE=$(date +%Y%m%d_%H%M%S)
RETENTION_DAYS=7

mkdir -p $BACKUP_DIR

# 备份数据库
cp /home/www/flask_project/data/new_questions.db $BACKUP_DIR/database_$DATE.db

# 备份配置文件
tar -czf $BACKUP_DIR/config_$DATE.tar.gz -C /home/www/flask_project .env gunicorn.conf.py

# 备份日志
tar -czf $BACKUP_DIR/logs_$DATE.tar.gz -C /home/www/flask_project/logs .

# 清理旧备份
find $BACKUP_DIR -name "database_*.db" -mtime +$RETENTION_DAYS -delete
find $BACKUP_DIR -name "config_*.tar.gz" -mtime +$RETENTION_DAYS -delete
find $BACKUP_DIR -name "logs_*.tar.gz" -mtime +$RETENTION_DAYS -delete

echo "$(date): 备份完成" >> $BACKUP_DIR/backup.log
EOF

chmod +x /home/www/backup_script.sh

# 每日2点自动备份
echo "0 2 * * * /home/www/backup_script.sh" | crontab -
```

## 🚨 常见问题解决

### 1. 应用无法启动

**症状**: supervisorctl status 显示 FATAL
```bash
# 查看详细错误
supervisorctl tail -f employee_assessment stderr

# 检查配置文件
sudo -u www bash -c "source venv/bin/activate && python -m py_compile production_app.py"

# 检查环境变量
sudo -u www bash -c "source venv/bin/activate && python -c 'import os; print(os.environ.get(\"SECRET_KEY\"))'"

# 手动测试启动
cd /home/www/flask_project
sudo -u www bash -c "source venv/bin/activate && python production_app.py"
```

### 2. 数据库连接错误

**症状**: 数据库相关错误
```bash
# 检查数据库文件存在和权限
ls -la /home/www/flask_project/data/new_questions.db

# 测试数据库连接
sqlite3 /home/www/flask_project/data/new_questions.db "SELECT COUNT(*) FROM questions;"

# 重新导入数据库
cd /home/www/flask_project
sudo -u www sqlite3 data/new_questions.db < database_migration.sql
```

### 3. Nginx代理错误

**症状**: 502 Bad Gateway
```bash
# 检查后端服务
curl http://127.0.0.1:8000/health

# 检查Nginx配置
nginx -t

# 查看Nginx错误日志
tail -f /var/log/nginx/error.log

# 重启Nginx
systemctl restart nginx
```

### 4. 端口占用问题

```bash
# 查看端口占用
netstat -tlnp | grep :80
netstat -tlnp | grep :8000

# 杀死占用进程
kill -9 PID

# 重启相关服务
supervisorctl restart employee_assessment
systemctl restart nginx
```

## 📋 部署检查清单

### 部署前检查 ✓
- [ ] 本地数据库已备份并生成迁移文件
- [ ] production.env 文件已正确配置
- [ ] Git仓库已创建并推送代码
- [ ] 腾讯云安全组已开放80、443端口
- [ ] SSH密钥或密码已准备

### 服务器配置检查 ✓
- [ ] 系统更新完成
- [ ] Python3、Nginx、Supervisor已安装
- [ ] www用户已创建
- [ ] 项目目录权限正确设置
- [ ] 虚拟环境创建并安装依赖
- [ ] 数据库导入成功

### 服务启动检查 ✓
- [ ] Nginx配置测试通过
- [ ] Supervisor配置正确
- [ ] Flask应用启动成功
- [ ] 防火墙配置完成
- [ ] 健康检查接口正常

### 功能测试检查 ✓
- [ ] 主页面可访问
- [ ] API接口正常
- [ ] 管理后台可访问
- [ ] 用户登录功能正常
- [ ] 测评流程完整
- [ ] 报告生成功能正常

### 安全配置检查 ✓
- [ ] SECRET_KEY已修改
- [ ] 管理员密码已修改
- [ ] DEEPSEEK_API_KEY已配置
- [ ] 文件权限正确设置
- [ ] SSL证书已配置（可选）

### 监控和备份检查 ✓
- [ ] 监控脚本已部署
- [ ] 自动备份已配置
- [ ] 日志轮转已设置
- [ ] 告警机制已建立

## 🎉 部署完成后的访问信息

**系统访问地址**:
- 主页: http://124.223.40.219
- 管理后台: http://124.223.40.219/manage
- 健康检查: http://124.223.40.219/health
- API接口: http://124.223.40.219/api/

**管理员登录**:
- 用户名: admin（或您设置的用户名）
- 密码: 您在 .env 文件中设置的密码

**重要文件位置**:
- 项目目录: `/home/www/flask_project`
- 数据库文件: `/home/www/flask_project/data/new_questions.db`
- 配置文件: `/home/www/flask_project/.env`
- 日志目录: `/home/www/flask_project/logs`
- 备份目录: `/home/www/flask_project/backup`

---

**🔔 最后提醒**: 
1. 定期检查服务状态和日志
2. 及时备份重要数据
3. 监控系统资源使用情况
4. 保持系统和依赖包的更新
5. 妥善保管数据库备份文件
