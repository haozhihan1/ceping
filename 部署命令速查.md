# å‘˜å·¥èƒ½åŠ›æµ‹è¯„ç³»ç»Ÿ - éƒ¨ç½²å‘½ä»¤é€ŸæŸ¥è¡¨

## ğŸš€ å¿«é€Ÿéƒ¨ç½²å‘½ä»¤

### æœ¬åœ°å‡†å¤‡
```bash
# ç”Ÿæˆæ•°æ®åº“è¿ç§»æ–‡ä»¶
python database_migration.py

# Gitæäº¤
git add .
git commit -m "Production deployment"
git push origin main

# ä½¿ç”¨è‡ªåŠ¨éƒ¨ç½²è„šæœ¬
chmod +x deploy_to_tencent_cloud.sh
./deploy_to_tencent_cloud.sh
```

### æœåŠ¡å™¨å¿«é€Ÿéƒ¨ç½²
```bash
# SSHè¿æ¥
ssh root@124.223.40.219

# ä¸€é”®å®‰è£…è„šæœ¬
curl -sSL https://raw.githubusercontent.com/your-repo/deploy.sh | bash
```

## ğŸ”§ æœåŠ¡ç®¡ç†å‘½ä»¤

### æœåŠ¡çŠ¶æ€æ£€æŸ¥
```bash
# æ£€æŸ¥æ‰€æœ‰æœåŠ¡çŠ¶æ€
systemctl status nginx supervisord
supervisorctl status employee_assessment

# æ£€æŸ¥ç«¯å£ç›‘å¬
netstat -tlnp | grep -E ':(80|8000)'

# å¥åº·æ£€æŸ¥
curl http://124.223.40.219/health
```

### æœåŠ¡é‡å¯
```bash
# é‡å¯Flaskåº”ç”¨
supervisorctl restart employee_assessment

# é‡å¯Nginx
systemctl restart nginx

# é‡å¯Supervisor
systemctl restart supervisord

# é‡æ–°åŠ è½½Nginxé…ç½®
nginx -s reload

# é‡æ–°åŠ è½½Supervisoré…ç½®
supervisorctl reread && supervisorctl update
```

### æŸ¥çœ‹æ—¥å¿—
```bash
# å®æ—¶æŸ¥çœ‹åº”ç”¨æ—¥å¿—
tail -f /var/log/supervisor/flask_app_stdout.log
tail -f /var/log/supervisor/flask_app_stderr.log

# å®æ—¶æŸ¥çœ‹Nginxæ—¥å¿—
tail -f /var/log/nginx/access.log
tail -f /var/log/nginx/error.log

# å®æ—¶æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—
journalctl -u nginx -f
journalctl -u supervisord -f

# æŸ¥çœ‹åº”ç”¨è‡ªå®šä¹‰æ—¥å¿—
tail -f /home/www/flask_project/logs/app.log
```

## ğŸ“Š ç›‘æ§å‘½ä»¤

### ç³»ç»Ÿèµ„æºç›‘æ§
```bash
# æŸ¥çœ‹ç³»ç»Ÿèµ„æº
htop                    # å®æ—¶è¿›ç¨‹ç›‘æ§
df -h                   # ç£ç›˜ä½¿ç”¨æƒ…å†µ
free -h                 # å†…å­˜ä½¿ç”¨æƒ…å†µ
iostat 1               # IOç»Ÿè®¡

# æŸ¥çœ‹ç½‘ç»œè¿æ¥
netstat -an | grep :80  # æŸ¥çœ‹80ç«¯å£è¿æ¥
ss -tuln               # æŸ¥çœ‹æ‰€æœ‰ç›‘å¬ç«¯å£

# æŸ¥çœ‹è¿›ç¨‹ä¿¡æ¯
ps aux | grep gunicorn  # æŸ¥çœ‹Gunicornè¿›ç¨‹
ps aux | grep nginx     # æŸ¥çœ‹Nginxè¿›ç¨‹
```

### åº”ç”¨ç›‘æ§
```bash
# æ£€æŸ¥æ•°æ®åº“è¿æ¥
sqlite3 /home/www/flask_project/data/new_questions.db "SELECT COUNT(*) FROM questions;"

# æ£€æŸ¥æ•°æ®åº“å®Œæ•´æ€§
sqlite3 /home/www/flask_project/data/new_questions.db "PRAGMA integrity_check;"

# æ£€æŸ¥æ–‡ä»¶æƒé™
ls -la /home/www/flask_project/data/
ls -la /home/www/flask_project/.env
```

## ğŸ—‚ï¸ æ•°æ®åº“ç®¡ç†

### å¤‡ä»½æ“ä½œ
```bash
# æ‰‹åŠ¨å¤‡ä»½æ•°æ®åº“
DATE=$(date +%Y%m%d_%H%M%S)
cp /home/www/flask_project/data/new_questions.db \
   /home/www/flask_project/backup/database_$DATE.db

# å¤‡ä»½é…ç½®æ–‡ä»¶
tar -czf /home/www/flask_project/backup/config_$DATE.tar.gz \
    -C /home/www/flask_project .env gunicorn.conf.py

# æ‰§è¡Œè‡ªåŠ¨å¤‡ä»½è„šæœ¬
/home/www/backup_script.sh
```

### æ•°æ®åº“ç»´æŠ¤
```bash
# ä¼˜åŒ–æ•°æ®åº“
sqlite3 /home/www/flask_project/data/new_questions.db "VACUUM;"

# é‡å»ºç´¢å¼•
sqlite3 /home/www/flask_project/data/new_questions.db "REINDEX;"

# æ£€æŸ¥è¡¨ç»“æ„
sqlite3 /home/www/flask_project/data/new_questions.db ".schema"

# å¯¼å‡ºæ•°æ®
sqlite3 /home/www/flask_project/data/new_questions.db ".dump" > backup.sql
```

### æ•°æ®æ¢å¤
```bash
# ä»SQLæ–‡ä»¶æ¢å¤
sqlite3 /home/www/flask_project/data/new_questions.db < database_migration.sql

# ä»å¤‡ä»½æ–‡ä»¶æ¢å¤
cp /home/www/flask_project/backup/database_20241017_140000.db \
   /home/www/flask_project/data/new_questions.db

# è®¾ç½®æ­£ç¡®æƒé™
chown www:www /home/www/flask_project/data/new_questions.db
chmod 664 /home/www/flask_project/data/new_questions.db
```

## ğŸ”„ ä»£ç æ›´æ–°æµç¨‹

### æ ‡å‡†æ›´æ–°æµç¨‹
```bash
# 1. æœ¬åœ°æäº¤æ›´æ–°
git add .
git commit -m "Update features"
git push origin main

# 2. æœåŠ¡å™¨æ‹‰å–æ›´æ–°
ssh root@124.223.40.219
cd /home/www/flask_project
sudo -u www git pull origin main

# 3. æ›´æ–°ä¾èµ–ï¼ˆå¦‚æœrequirements.txtæœ‰å˜åŒ–ï¼‰
sudo -u www bash -c "source venv/bin/activate && pip install -r requirements.txt"

# 4. é‡å¯åº”ç”¨
supervisorctl restart employee_assessment

# 5. éªŒè¯æ›´æ–°
curl http://124.223.40.219/health
```

### çƒ­æ›´æ–°ï¼ˆæ— ä¸­æ–­ï¼‰
```bash
# é‡æ–°åŠ è½½é…ç½®ï¼ˆä¸é‡å¯è¿›ç¨‹ï¼‰
kill -HUP $(pgrep -f gunicorn)

# æˆ–ä½¿ç”¨graceful reload
supervisorctl signal HUP employee_assessment
```

## ğŸš¨ æ•…éšœæ’é™¤å‘½ä»¤

### åº”ç”¨æ— æ³•å¯åŠ¨
```bash
# æŸ¥çœ‹å¯åŠ¨é”™è¯¯
supervisorctl tail -f employee_assessment stderr

# æ‰‹åŠ¨å¯åŠ¨æµ‹è¯•
cd /home/www/flask_project
sudo -u www bash -c "source venv/bin/activate && python production_app.py"

# æ£€æŸ¥é…ç½®è¯­æ³•
sudo -u www bash -c "source venv/bin/activate && python -m py_compile production_app.py"

# æ£€æŸ¥ç¯å¢ƒå˜é‡
sudo -u www bash -c "source venv/bin/activate && env | grep -E '(SECRET_KEY|DEEPSEEK_API_KEY)'"
```

### 502é”™è¯¯æ’æŸ¥
```bash
# æ£€æŸ¥åç«¯æœåŠ¡
curl -I http://127.0.0.1:8000/

# æ£€æŸ¥Nginxé…ç½®
nginx -t

# æŸ¥çœ‹Nginxé”™è¯¯
tail -n 50 /var/log/nginx/error.log

# æ£€æŸ¥upstreamè¿æ¥
telnet 127.0.0.1 8000
```

### æ•°æ®åº“é—®é¢˜æ’æŸ¥
```bash
# æ£€æŸ¥æ•°æ®åº“æ–‡ä»¶
file /home/www/flask_project/data/new_questions.db

# æ£€æŸ¥æƒé™
ls -la /home/www/flask_project/data/

# æµ‹è¯•æ•°æ®åº“è¿æ¥
sqlite3 /home/www/flask_project/data/new_questions.db ".tables"

# æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
sqlite3 /home/www/flask_project/data/new_questions.db "PRAGMA quick_check;"
```

### å†…å­˜/CPUé—®é¢˜æ’æŸ¥
```bash
# æŸ¥çœ‹èµ„æºå ç”¨æœ€é«˜çš„è¿›ç¨‹
top -o %CPU
top -o %MEM

# æŸ¥çœ‹åº”ç”¨å†…å­˜ä½¿ç”¨
ps aux --sort=-%mem | head -10

# åˆ†æå†…å­˜æ³„æ¼
pmap -x $(pgrep -f gunicorn)

# é‡å¯èµ„æºå ç”¨è¿‡é«˜çš„è¿›ç¨‹
supervisorctl restart employee_assessment
```

## ğŸ”’ å®‰å…¨ç»´æŠ¤

### SSLè¯ä¹¦ç®¡ç†
```bash
# æ£€æŸ¥è¯ä¹¦çŠ¶æ€
certbot certificates

# æ‰‹åŠ¨ç»­æœŸè¯ä¹¦
certbot renew

# æµ‹è¯•ç»­æœŸ
certbot renew --dry-run

# å¼ºåˆ¶ç»­æœŸ
certbot renew --force-renewal
```

### å®‰å…¨æ£€æŸ¥
```bash
# æ£€æŸ¥å¼€æ”¾ç«¯å£
nmap -sT -O localhost

# æ£€æŸ¥SSHç™»å½•æ—¥å¿—
grep "sshd" /var/log/secure | tail -20

# æ£€æŸ¥å¤±è´¥ç™»å½•
grep "Failed password" /var/log/secure | tail -10

# æ›´æ–°ç³»ç»Ÿå®‰å…¨è¡¥ä¸
yum update --security -y
```

### æƒé™æ£€æŸ¥
```bash
# æ£€æŸ¥é‡è¦æ–‡ä»¶æƒé™
ls -la /home/www/flask_project/.env
ls -la /home/www/flask_project/data/
ls -la /etc/nginx/nginx.conf

# ä¿®å¤æƒé™é—®é¢˜
chown -R www:www /home/www/flask_project
chmod 600 /home/www/flask_project/.env
chmod 664 /home/www/flask_project/data/new_questions.db
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### ç³»ç»Ÿä¼˜åŒ–
```bash
# æŸ¥çœ‹ç³»ç»Ÿè´Ÿè½½
uptime
w
vmstat 1 5

# ä¼˜åŒ–æ•°æ®åº“
sqlite3 /home/www/flask_project/data/new_questions.db "ANALYZE;"

# æ¸…ç†æ—¥å¿—æ–‡ä»¶
find /var/log -name "*.log" -mtime +7 -exec rm -f {} \;
find /home/www/flask_project/logs -name "*.log.*" -mtime +7 -delete

# æ¸…ç†ä¸´æ—¶æ–‡ä»¶
rm -rf /tmp/*
```

### ç¼“å­˜æ¸…ç†
```bash
# æ¸…ç†ç³»ç»Ÿç¼“å­˜
echo 3 > /proc/sys/vm/drop_caches

# æ¸…ç†Pythonç¼“å­˜
find /home/www/flask_project -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null

# é‡å»ºpipç¼“å­˜
sudo -u www bash -c "source venv/bin/activate && pip cache purge"
```

## ğŸ”„ å®šæ—¶ä»»åŠ¡ç®¡ç†

### æŸ¥çœ‹å®šæ—¶ä»»åŠ¡
```bash
# æŸ¥çœ‹ç³»ç»Ÿå®šæ—¶ä»»åŠ¡
crontab -l

# æŸ¥çœ‹ç”¨æˆ·å®šæ—¶ä»»åŠ¡
crontab -l -u www

# ç¼–è¾‘å®šæ—¶ä»»åŠ¡
crontab -e
```

### å¸¸ç”¨å®šæ—¶ä»»åŠ¡æ¨¡æ¿
```bash
# æ¯æ—¥å¤‡ä»½ï¼ˆå‡Œæ™¨2ç‚¹ï¼‰
0 2 * * * /home/www/backup_script.sh

# æ¯5åˆ†é’Ÿç›‘æ§æ£€æŸ¥
*/5 * * * * /home/www/monitor.sh

# æ¯å‘¨æ—¥å¿—æ¸…ç†ï¼ˆå‘¨æ—¥å‡Œæ™¨3ç‚¹ï¼‰
0 3 * * 0 find /var/log -name "*.log" -mtime +7 -delete

# æ¯æœˆSSLè¯ä¹¦ç»­æœŸæ£€æŸ¥
0 0 1 * * certbot renew --quiet

# æ¯å°æ—¶é‡å¯åº”ç”¨ï¼ˆå¦‚æœéœ€è¦ï¼‰
0 * * * * supervisorctl restart employee_assessment
```

---

**ğŸ’¡ æç¤º**: 
- æ‰€æœ‰å‘½ä»¤éƒ½éœ€è¦åœ¨å¯¹åº”çš„ç›®å½•ä¸‹æ‰§è¡Œ
- æ¶‰åŠsudoæ“ä½œè¯·ç¡®ä¿æœ‰è¶³å¤Ÿæƒé™
- æ‰§è¡Œé‡è¦æ“ä½œå‰å»ºè®®å…ˆå¤‡ä»½
- å®šæœŸæ£€æŸ¥ç³»ç»Ÿèµ„æºå’Œæ—¥å¿—
- é‡åˆ°é—®é¢˜æ—¶å…ˆæŸ¥çœ‹ç›¸å…³æ—¥å¿—æ–‡ä»¶
