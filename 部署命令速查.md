# 员工能力测评系统 - 部署命令速查表

## 🚀 快速部署命令

### 本地准备
```bash
# 生成数据库迁移文件
python database_migration.py

# Git提交
git add .
git commit -m "Production deployment"
git push origin main

# 使用自动部署脚本
chmod +x deploy_to_tencent_cloud.sh
./deploy_to_tencent_cloud.sh
```

### 服务器快速部署
```bash
# SSH连接
ssh root@124.223.40.219

# 一键安装脚本
curl -sSL https://raw.githubusercontent.com/your-repo/deploy.sh | bash
```

## 🔧 服务管理命令

### 服务状态检查
```bash
# 检查所有服务状态
systemctl status nginx supervisord
supervisorctl status employee_assessment

# 检查端口监听
netstat -tlnp | grep -E ':(80|8000)'

# 健康检查
curl http://124.223.40.219/health
```

### 服务重启
```bash
# 重启Flask应用
supervisorctl restart employee_assessment

# 重启Nginx
systemctl restart nginx

# 重启Supervisor
systemctl restart supervisord

# 重新加载Nginx配置
nginx -s reload

# 重新加载Supervisor配置
supervisorctl reread && supervisorctl update
```

### 查看日志
```bash
# 实时查看应用日志
tail -f /var/log/supervisor/flask_app_stdout.log
tail -f /var/log/supervisor/flask_app_stderr.log

# 实时查看Nginx日志
tail -f /var/log/nginx/access.log
tail -f /var/log/nginx/error.log

# 实时查看系统日志
journalctl -u nginx -f
journalctl -u supervisord -f

# 查看应用自定义日志
tail -f /home/www/flask_project/logs/app.log
```

## 📊 监控命令

### 系统资源监控
```bash
# 查看系统资源
htop                    # 实时进程监控
df -h                   # 磁盘使用情况
free -h                 # 内存使用情况
iostat 1               # IO统计

# 查看网络连接
netstat -an | grep :80  # 查看80端口连接
ss -tuln               # 查看所有监听端口

# 查看进程信息
ps aux | grep gunicorn  # 查看Gunicorn进程
ps aux | grep nginx     # 查看Nginx进程
```

### 应用监控
```bash
# 检查数据库连接
sqlite3 /home/www/flask_project/data/new_questions.db "SELECT COUNT(*) FROM questions;"

# 检查数据库完整性
sqlite3 /home/www/flask_project/data/new_questions.db "PRAGMA integrity_check;"

# 检查文件权限
ls -la /home/www/flask_project/data/
ls -la /home/www/flask_project/.env
```

## 🗂️ 数据库管理

### 备份操作
```bash
# 手动备份数据库
DATE=$(date +%Y%m%d_%H%M%S)
cp /home/www/flask_project/data/new_questions.db \
   /home/www/flask_project/backup/database_$DATE.db

# 备份配置文件
tar -czf /home/www/flask_project/backup/config_$DATE.tar.gz \
    -C /home/www/flask_project .env gunicorn.conf.py

# 执行自动备份脚本
/home/www/backup_script.sh
```

### 数据库维护
```bash
# 优化数据库
sqlite3 /home/www/flask_project/data/new_questions.db "VACUUM;"

# 重建索引
sqlite3 /home/www/flask_project/data/new_questions.db "REINDEX;"

# 检查表结构
sqlite3 /home/www/flask_project/data/new_questions.db ".schema"

# 导出数据
sqlite3 /home/www/flask_project/data/new_questions.db ".dump" > backup.sql
```

### 数据恢复
```bash
# 从SQL文件恢复
sqlite3 /home/www/flask_project/data/new_questions.db < database_migration.sql

# 从备份文件恢复
cp /home/www/flask_project/backup/database_20241017_140000.db \
   /home/www/flask_project/data/new_questions.db

# 设置正确权限
chown www:www /home/www/flask_project/data/new_questions.db
chmod 664 /home/www/flask_project/data/new_questions.db
```

## 🔄 代码更新流程

### 标准更新流程
```bash
# 1. 本地提交更新
git add .
git commit -m "Update features"
git push origin main

# 2. 服务器拉取更新
ssh root@124.223.40.219
cd /home/www/flask_project
sudo -u www git pull origin main

# 3. 更新依赖（如果requirements.txt有变化）
sudo -u www bash -c "source venv/bin/activate && pip install -r requirements.txt"

# 4. 重启应用
supervisorctl restart employee_assessment

# 5. 验证更新
curl http://124.223.40.219/health
```

### 热更新（无中断）
```bash
# 重新加载配置（不重启进程）
kill -HUP $(pgrep -f gunicorn)

# 或使用graceful reload
supervisorctl signal HUP employee_assessment
```

## 🚨 故障排除命令

### 应用无法启动
```bash
# 查看启动错误
supervisorctl tail -f employee_assessment stderr

# 手动启动测试
cd /home/www/flask_project
sudo -u www bash -c "source venv/bin/activate && python production_app.py"

# 检查配置语法
sudo -u www bash -c "source venv/bin/activate && python -m py_compile production_app.py"

# 检查环境变量
sudo -u www bash -c "source venv/bin/activate && env | grep -E '(SECRET_KEY|DEEPSEEK_API_KEY)'"
```

### 502错误排查
```bash
# 检查后端服务
curl -I http://127.0.0.1:8000/

# 检查Nginx配置
nginx -t

# 查看Nginx错误
tail -n 50 /var/log/nginx/error.log

# 检查upstream连接
telnet 127.0.0.1 8000
```

### 数据库问题排查
```bash
# 检查数据库文件
file /home/www/flask_project/data/new_questions.db

# 检查权限
ls -la /home/www/flask_project/data/

# 测试数据库连接
sqlite3 /home/www/flask_project/data/new_questions.db ".tables"

# 检查数据完整性
sqlite3 /home/www/flask_project/data/new_questions.db "PRAGMA quick_check;"
```

### 内存/CPU问题排查
```bash
# 查看资源占用最高的进程
top -o %CPU
top -o %MEM

# 查看应用内存使用
ps aux --sort=-%mem | head -10

# 分析内存泄漏
pmap -x $(pgrep -f gunicorn)

# 重启资源占用过高的进程
supervisorctl restart employee_assessment
```

## 🔒 安全维护

### SSL证书管理
```bash
# 检查证书状态
certbot certificates

# 手动续期证书
certbot renew

# 测试续期
certbot renew --dry-run

# 强制续期
certbot renew --force-renewal
```

### 安全检查
```bash
# 检查开放端口
nmap -sT -O localhost

# 检查SSH登录日志
grep "sshd" /var/log/secure | tail -20

# 检查失败登录
grep "Failed password" /var/log/secure | tail -10

# 更新系统安全补丁
yum update --security -y
```

### 权限检查
```bash
# 检查重要文件权限
ls -la /home/www/flask_project/.env
ls -la /home/www/flask_project/data/
ls -la /etc/nginx/nginx.conf

# 修复权限问题
chown -R www:www /home/www/flask_project
chmod 600 /home/www/flask_project/.env
chmod 664 /home/www/flask_project/data/new_questions.db
```

## 📈 性能优化

### 系统优化
```bash
# 查看系统负载
uptime
w
vmstat 1 5

# 优化数据库
sqlite3 /home/www/flask_project/data/new_questions.db "ANALYZE;"

# 清理日志文件
find /var/log -name "*.log" -mtime +7 -exec rm -f {} \;
find /home/www/flask_project/logs -name "*.log.*" -mtime +7 -delete

# 清理临时文件
rm -rf /tmp/*
```

### 缓存清理
```bash
# 清理系统缓存
echo 3 > /proc/sys/vm/drop_caches

# 清理Python缓存
find /home/www/flask_project -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null

# 重建pip缓存
sudo -u www bash -c "source venv/bin/activate && pip cache purge"
```

## 🔄 定时任务管理

### 查看定时任务
```bash
# 查看系统定时任务
crontab -l

# 查看用户定时任务
crontab -l -u www

# 编辑定时任务
crontab -e
```

### 常用定时任务模板
```bash
# 每日备份（凌晨2点）
0 2 * * * /home/www/backup_script.sh

# 每5分钟监控检查
*/5 * * * * /home/www/monitor.sh

# 每周日志清理（周日凌晨3点）
0 3 * * 0 find /var/log -name "*.log" -mtime +7 -delete

# 每月SSL证书续期检查
0 0 1 * * certbot renew --quiet

# 每小时重启应用（如果需要）
0 * * * * supervisorctl restart employee_assessment
```

---

**💡 提示**: 
- 所有命令都需要在对应的目录下执行
- 涉及sudo操作请确保有足够权限
- 执行重要操作前建议先备份
- 定期检查系统资源和日志
- 遇到问题时先查看相关日志文件
